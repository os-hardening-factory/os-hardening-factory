name: ğŸŸ© Amazon Linux 2 CIS Hardening Build

on:
  workflow_dispatch:

jobs:
  build-amazonlinux:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "amazonlinux"
      OS_VERSION: "2"
      CIS_VERSION: "1.3"
      AWS_REGION: "ap-south-1"
      PACKER_VERSION: "1.11.2"

    steps:
      # -----------------------------------------------------------
      # ğŸ§¾ Checkout source code
      # -----------------------------------------------------------
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # ğŸ” Configure AWS credentials via OIDC (for AMI builds or S3 upload)
      # -----------------------------------------------------------
      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # -----------------------------------------------------------
      # ğŸ“¦ Install Packer
      # -----------------------------------------------------------
      - name: ğŸ“¦ Install Packer (binary)
        run: |
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

      # -----------------------------------------------------------
      # ğŸ§° Verify build structure for debugging
      # -----------------------------------------------------------
      - name: ğŸ§° Verify Packer and Ansible directories
        run: |
          echo "Current workspace: $(pwd)"
          ls -R packer/amazonlinux || echo "âŒ packer/amazonlinux missing"
          ls -R packer/amazonlinux/ansible || echo "âŒ ansible folder missing"

      # -----------------------------------------------------------
      # ğŸ§© Initialize and validate Packer template
      # (Use working-directory to fix relative path issue)
      # -----------------------------------------------------------
      - name: ğŸ§© Initialize and validate Packer template
        working-directory: packer/amazonlinux
        run: |
          packer init .
          packer validate -var "image_name=${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-$(date +%Y%m%d)" .

      # -----------------------------------------------------------
      # ğŸ—ï¸ Build CIS-hardened Docker image
      # -----------------------------------------------------------
      - name: ğŸ—ï¸ Build Amazon Linux CIS image
        working-directory: packer/amazonlinux
        run: |
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-$(date +%Y%m%d)"
          echo "Building image: ${TAG}"
          packer build -var "image_name=${TAG}" .

      # -----------------------------------------------------------
      # ğŸ” Security Scan using Trivy (container-level CVE scan)
      # -----------------------------------------------------------
      - name: ğŸ” Trivy Image Scan
        run: |
          echo "Scanning hardened image with Trivy..."
          mkdir -p reports
          docker images
          trivy image "${{ env.OS_NAME }}-${{ env.OS_VERSION }}:latest" -f json -o reports/trivy-${{ env.OS_NAME }}.json || true

      # -----------------------------------------------------------
      # ğŸ“¤ Upload Trivy report as an artifact
      # -----------------------------------------------------------
      - name: ğŸ“¤ Upload Trivy scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-report
          path: reports/trivy-${{ env.OS_NAME }}.json
          if-no-files-found: warn
