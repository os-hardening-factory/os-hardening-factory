name: üü© Amazon Linux 2 CIS Hardening Build

on:
  workflow_dispatch:

jobs:
  build-amazonlinux:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "amazonlinux"
      OS_VERSION: "2"
      CIS_VERSION: "1.3"
      AWS_REGION: "ap-south-1"
      PACKER_VERSION: "1.11.2"

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: üì¶ Install Packer (binary)
        run: |
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

      - name: üß© Initialize and validate Packer template
        run: |
          packer init packer/amazonlinux
          packer validate -var "image_name=${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-$(date +%Y%m%d)" packer/amazonlinux

      - name: üèóÔ∏è Build Amazon Linux CIS image
        run: |
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-$(date +%Y%m%d)"
          packer build -var "image_name=${TAG}" packer/amazonlinux

      - name: üîç Trivy Scan
        run: |
          mkdir -p reports
          trivy image "${{ env.OS_NAME }}-${{ env.OS_VERSION }}:latest" -f json -o reports/trivy-${{ env.OS_NAME }}.json || true
