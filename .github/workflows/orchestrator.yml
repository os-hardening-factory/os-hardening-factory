name: üè≠ OS Hardening Orchestrator

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "Select OS vendor (amazonlinux, ubuntu, rhel, or all)"
        required: true
        default: "all"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        os_type: ${{ fromJson(github.event.inputs.vendor == 'all' && '["amazonlinux","ubuntu","rhel"]' || format('["{0}"]', github.event.inputs.vendor)) }}
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout orchestrator repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ap-south-1

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y packer python3-pip
          pip3 install boto3 PyGithub

      - name: Initialize and build hardened image
        run: |
          packer init packer/${{ matrix.os_type }}
          packer build -var "local_tag=${{ matrix.os_type }}-hardened:v1.0.0-cis1.4-$(date +%Y%m%d)-${GITHUB_SHA::7}" packer/${{ matrix.os_type }}

      - name: Scan image using Trivy
        run: |
          trivy image 661539128717.dkr.ecr.ap-south-1.amazonaws.com/hardened-${{ matrix.os_type }}:latest \
            -f json -o reports/trivy-${{ matrix.os_type }}.json || true

      - name: Upload compliance report to S3
        run: python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ap-south-1

      - name: Update vendor repo changelog + release
        run: |
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor ${{ matrix.os_type }} \
            --cis_profile "cis1.4" \
            --version "v1.0.0" \
            --build_date "$(date +%Y%m%d)" \
            --summary "CIS 1.4 compliance, CVE patches, and OS security updates"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
