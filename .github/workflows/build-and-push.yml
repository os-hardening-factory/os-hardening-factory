name: üß± Build & Push Hardened Image to AWS ECR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  IMAGE_NAME: os-hardened-base
  ECR_REGISTRY: 661539128717.dkr.ecr.us-east-1.amazonaws.com
  BUCKET_NAME: cloud-secure-infra-os-hardening-metadata

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: üî® Build & Push Hardened Image
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # Configure AWS credentials via OIDC (no static keys)
      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubOIDC-ECRPushRole
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      # Login to Amazon ECR
      - name: üîë Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # Build and tag Docker image
      - name: üèóÔ∏è Build Docker image
        run: |
          docker build -t $ECR_REGISTRY/$IMAGE_NAME:latest .

      # Push Docker image to ECR
      - name: üöÄ Push image to Amazon ECR
        run: |
          docker push $ECR_REGISTRY/$IMAGE_NAME:latest

      # Generate metadata JSON file
      - name: üì¶ Generate image metadata file
        id: metadata
        run: |
          echo "{
            \"project\": \"os-hardening-factory\",
            \"repository\": \"${{ github.repository }}\",
            \"image_name\": \"${{ env.IMAGE_NAME }}\",
            \"image_tag\": \"latest\",
            \"commit_sha\": \"${{ github.sha }}\",
            \"pushed_by\": \"${{ github.actor }}\",
            \"timestamp\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"source\": \"GitHub Actions\",
            \"compliance\": \"CIS-Benchmark\",
            \"version\": \"v1.0.0\"
          }" > image_metadata.json

      # Upload metadata to S3
      - name: ‚òÅÔ∏è Upload metadata to S3
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          BUCKET_NAME: ${{ env.BUCKET_NAME }}
        run: |
          aws s3 cp image_metadata.json s3://$BUCKET_NAME/metadata/${{ github.run_number }}.json

      # Optional: Verify upload
      - name: üîç Verify uploaded metadata file
        run: |
          aws s3 ls s3://$BUCKET_NAME/metadata/ --recursive | tail -n 5
