name: ðŸš€ Promote Hardened Image to Prod (Security Gating + Signing + Verification + Release Publishing)

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "OS vendor (e.g., ubuntu, rhel, amazonlinux)"
        required: true
        default: "ubuntu"
      source_tag:
        description: "Existing tag to promote (e.g., ubuntu-22.04-intuit-1)"
        required: true
      target_tag:
        description: "New promotion tag (e.g., ubuntu-22.04-intuit-prod)"
        required: true
        default: "ubuntu-22.04-intuit-prod"
      cis_profile:
        description: "CIS profile version (e.g., cis1.4)"
        required: true
        default: "cis1.4"
      version:
        description: "OS version (e.g., 22.04)"
        required: true
        default: "22.04"

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      AWS_REGION: ap-south-1
      ACCOUNT_ID: "661539128717"
      KMS_KEY_ARN: "arn:aws:kms:ap-south-1:661539128717:alias/cosign-signing"

    steps:
      # ---------- Step 1: Setup ----------
      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ§¾ Checkout os-hardening-orchestrator repository
        uses: actions/checkout@v4
        with:
          repository: os-hardening-factory/os-hardening-orchestrator
          fetch-depth: 0

      - name: ðŸ§¾ Log input parameters
        run: |
          echo "Vendor        : ${{ github.event.inputs.vendor }}"
          echo "Source tag    : ${{ github.event.inputs.source_tag }}"
          echo "Target tag    : ${{ github.event.inputs.target_tag }}"
          echo "CIS profile   : ${{ github.event.inputs.cis_profile }}"
          echo "Version       : ${{ github.event.inputs.version }}"

      # ---------- Step 2: Install Tools ----------
      - name: ðŸ” Install Trivy & Cosign
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
          wget -q https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64 -O /usr/local/bin/cosign
          chmod +x /usr/local/bin/cosign
          echo "âœ… Tools installed successfully"

      # ---------- Step 3: Security Gating ----------
      - name: ðŸ›¡ï¸ Security Gate (Trivy CVE check)
        env:
          VENDOR: ${{ github.event.inputs.vendor }}
          SOURCE_TAG: ${{ github.event.inputs.source_tag }}
          ACCOUNT_ID: ${{ env.ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          BLOCK_SEVERITIES: "CRITICAL,HIGH"
        run: |
          set -euo pipefail
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/hardened-${VENDOR}"
          IMG="${REPO}:${SOURCE_TAG}"
          aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${REPO}
          docker pull "${IMG}"
          mkdir -p reports
          trivy image --timeout 5m --severity ${BLOCK_SEVERITIES} \
            --format json --output "reports/trivy-${VENDOR}-${SOURCE_TAG}.json" "${IMG}" || true
          CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' reports/trivy-${VENDOR}-${SOURCE_TAG}.json)
          echo "CRITICAL=${CRIT} HIGH=${HIGH}"
          if [ "${CRIT}" -gt 0 ] || [ "${HIGH}" -gt 0 ]; then
            echo "âŒ Blocked due to critical vulnerabilities"
            exit 1
          fi
          echo "âœ… Passed security gate"

      # ---------- Step 4: Promote Image ----------
      - name: ðŸ§± Retag and push image (Prod)
        if: success()
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          SRC=${{ github.event.inputs.source_tag }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${REPO}
          docker pull ${REPO}:${SRC}
          docker tag  ${REPO}:${SRC} ${REPO}:${DST}
          docker push ${REPO}:${DST}
          echo "âœ… Promoted ${REPO}:${SRC} â†’ ${REPO}:${DST}"

      # ---------- Step 5: Sign Image ----------
      - name: ðŸ” Sign Hardened Image (AWS KMS)
        env:
          COSIGN_EXPERIMENTAL: "true"
          AWS_REGION: ap-south-1
        run: |
          set -euo pipefail
          VENDOR=${{ github.event.inputs.vendor }}
          IMAGE="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}:${{ github.event.inputs.target_tag }}"
          echo "ðŸ” Signing image with AWS KMS key alias/cosign-signing"
          cosign sign --key "awskms:///alias/cosign-signing" "${IMAGE}"
          echo "âœ… Successfully signed ${IMAGE}"

      # ---------- Step 6: Verify Signature ----------
      - name: ðŸ” Verify Signed Image
        env:
          COSIGN_EXPERIMENTAL: "true"
          AWS_REGION: ap-south-1
        run: |
          set -euo pipefail
          VENDOR=${{ github.event.inputs.vendor }}
          IMAGE="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}:${{ github.event.inputs.target_tag }}"
          echo "ðŸ” Verifying signed image..."
          cosign verify --key "awskms:///alias/cosign-signing" "${IMAGE}" > reports/cosign-verify-${VENDOR}.json
          echo "âœ… Signature verified successfully for ${IMAGE}"

      # ---------- Step 7: Release Publishing ----------
      - name: ðŸ Install Python dependencies for GitHub release dispatch
        run: |
          python3 -m pip install --upgrade pip
          pip install PyGithub

      - name: ðŸš€ Dispatch release to vendor repo
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          DATE=$(date +%Y%m%d)
          SUMMARY="Image promoted to prod after signing and verification. CRITICAL/HIGH CVEs = 0."
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ github.event.inputs.vendor }}" \
            --cis_profile "${{ github.event.inputs.cis_profile }}" \
            --version "${{ github.event.inputs.version }}" \
            --build_date "${DATE}" \
            --summary "${SUMMARY}"
          echo "âœ… Vendor release created"

      # ---------- Step 8: Upload Reports ----------
      - name: ðŸ“Š Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "${{ github.event.inputs.vendor }}-reports"
          path: reports/
          retention-days: 30

      # ---------- Step 9: Final Audit Summary ----------
      - name: ðŸ§¾ Generate final audit summary
        if: always()
        run: |
          echo "âœ… Hardened Image Promotion Summary" > summary.md
          echo "----------------------------------" >> summary.md
          echo "ðŸ§© Vendor:        ${{ github.event.inputs.vendor }}" >> summary.md
          echo "ðŸ·ï¸  Source Tag:   ${{ github.event.inputs.source_tag }}" >> summary.md
          echo "ðŸš€ Target Tag:    ${{ github.event.inputs.target_tag }}" >> summary.md
          echo "ðŸ”– Release:       ${{ github.event.inputs.version }}-${{ github.event.inputs.cis_profile }}" >> summary.md
          echo "ðŸ›¡ï¸  CVE Status:   PASSED (0 CRITICAL / 0 HIGH)" >> summary.md
          echo "ðŸ” Signature:     Verified successfully (KMS alias/cosign-signing)" >> summary.md
          echo "ðŸ“¦ ECR Image:     ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ github.event.inputs.vendor }}:${{ github.event.inputs.target_tag }}" >> summary.md
          echo "ðŸ“… Date:          $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> summary.md
          cat summary.md

      - name: ðŸ“¤ Upload audit summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-summary-${{ github.event.inputs.vendor }}
          path: summary.md
          retention-days: 30
