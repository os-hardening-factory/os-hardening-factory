name: ðŸš€ Promote Hardened Image to Prod (with Security Gating)

on:
  workflow_dispatch:
    inputs:
      vendor:
        description: "OS vendor (e.g., ubuntu, rhel, amazonlinux)"
        required: true
        default: "ubuntu"
      source_tag:
        description: "Existing tag to promote (e.g., ubuntu-22.04-intuit-1)"
        required: true
      target_tag:
        description: "New promotion tag (e.g., ubuntu-22.04-intuit-prod)"
        required: true
        default: "ubuntu-22.04-intuit-prod"

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ap-south-1
      ACCOUNT_ID: "661539128717"

    steps:
      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ§¾ Log input parameters
        run: |
          echo "Vendor        : ${{ github.event.inputs.vendor }}"
          echo "Source tag    : ${{ github.event.inputs.source_tag }}"
          echo "Target tag    : ${{ github.event.inputs.target_tag }}"

      # -------------------------------------------------------------------
      #  Phase 2 â€“ Step 2.1 : Automated Security Gating using Trivy
      # -------------------------------------------------------------------
      - name: ðŸ” Install Trivy
        run: |
          echo "ðŸ“¦ Installing Trivy vulnerability scanner..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin
          trivy --version
          echo "âœ… Trivy installed successfully."

      - name: ðŸ›¡ï¸ Security Gate (Trivy CVE check)
        env:
          VENDOR: ${{ github.event.inputs.vendor }}
          SOURCE_TAG: ${{ github.event.inputs.source_tag }}
          ACCOUNT_ID: ${{ env.ACCOUNT_ID }}
          AWS_REGION: ${{ env.AWS_REGION }}
          BLOCK_SEVERITIES: "CRITICAL,HIGH"
        run: |
          set -euo pipefail
          REPO="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/hardened-${VENDOR}"
          IMG="${REPO}:${SOURCE_TAG}"

          echo "ðŸ”Ž Scanning image for vulnerabilities: ${IMG}"

          # Authenticate & pull image
          aws ecr get-login-password --region ${AWS_REGION} \
            | docker login --username AWS --password-stdin ${REPO}
          docker pull "${IMG}"

          mkdir -p reports
          echo "ðŸ§ª Running Trivy scan for severities: ${BLOCK_SEVERITIES}"
          trivy image --timeout 5m \
            --severity ${BLOCK_SEVERITIES} \
            --format json \
            --output "reports/trivy-${VENDOR}-${SOURCE_TAG}.json" \
            "${IMG}" || true

          # Parse Trivy output to count vulnerabilities
          CRIT=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "reports/trivy-${VENDOR}-${SOURCE_TAG}.json")
          HIGH=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "reports/trivy-${VENDOR}-${SOURCE_TAG}.json")

          echo "ðŸ”¢ Vulnerability counts â†’ CRITICAL=${CRIT}, HIGH=${HIGH}"
          if [ "${CRIT}" -gt 0 ] || [ "${HIGH}" -gt 0 ]; then
            echo "âŒ Security gate failed: Found CRITICAL/HIGH vulnerabilities."
            echo "ðŸ§¾ Detailed report saved to reports/trivy-${VENDOR}-${SOURCE_TAG}.json"
            exit 1
          fi

          echo "âœ… Security gate passed: No CRITICAL/HIGH vulnerabilities found."

      # -------------------------------------------------------------------
      #  Step 2.1 (continued): Promote image only if gate passes
      # -------------------------------------------------------------------
      - name: ðŸ§± Pull, retag, and push image (Prod)
        if: success() # runs only if Trivy gate passed
        run: |
          VENDOR=${{ github.event.inputs.vendor }}
          SRC=${{ github.event.inputs.source_tag }}
          DST=${{ github.event.inputs.target_tag }}
          REPO="${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${VENDOR}"

          echo "ðŸ”¹ Promoting ${REPO}:${SRC} â†’ ${REPO}:${DST}"
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${REPO}

          docker pull ${REPO}:${SRC}
          docker tag  ${REPO}:${SRC} ${REPO}:${DST}
          docker push ${REPO}:${DST}

          echo "âœ… Promotion complete: ${REPO}:${DST}"

      # -------------------------------------------------------------------
      #  Step 2.1 (continued): Always upload scan report
      # -------------------------------------------------------------------
      - name: ðŸ“Š Upload Trivy report (for audit)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ github.event.inputs.vendor }}-${{ github.event.inputs.source_tag }}
          path: reports/
          retention-days: 30

      - name: ðŸ§¾ Record promotion details
        if: success()
        run: |
          echo "timestamp=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "Promoted image details:"
          echo "  Vendor     : ${{ github.event.inputs.vendor }}"
          echo "  Source Tag : ${{ github.event.inputs.source_tag }}"
          echo "  Target Tag : ${{ github.event.inputs.target_tag }}"
          echo "  Time (UTC) : $(date -u)"
