name: üêß Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"

    steps:
      # ---------------------------------------------------------------------
      # Step 1 - Checkout repository
      # ---------------------------------------------------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------------------
      # Step 2 - Configure AWS (OIDC)
      # ---------------------------------------------------------------------
      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------------------
      # Step 3 - Install Dependencies (Safe Sequence)
      # ---------------------------------------------------------------------
      - name: üîß Install dependencies
        run: |
          echo "üîß Installing dependencies (safe sequence)..."
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip software-properties-common gpg

          # Install HashiCorp repo & Packer
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com noble main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update && sudo apt-get install -y packer
          packer version

          # Install Trivy securely
          echo "üì¶ Installing Trivy..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          trivy --version

          # Python libraries
          pip3 install boto3 PyGithub
          echo "‚úÖ All dependencies installed successfully."

      # ---------------------------------------------------------------------
      # Step 4 - Install required Packer plugins
      # ---------------------------------------------------------------------
      - name: üß© Install Packer plugins
        run: |
          echo "üß© Installing Packer plugins..."
          packer plugins install github.com/hashicorp/docker
          packer plugins install github.com/hashicorp/ansible
          echo "‚úÖ Packer plugins installed."

      # ---------------------------------------------------------------------
      # Step 5 - Build Hardened Ubuntu Image
      # ---------------------------------------------------------------------
      - name: üèóÔ∏è Build hardened Ubuntu image
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          echo "üöÄ Building hardened image: $TAG"
          packer init packer/ubuntu
          packer validate packer/ubuntu
          packer build \
            -var "local_tag=latest" \
            -var "image_name=${TAG}" \
            -var "base_image=ubuntu:22.04" \
            packer/ubuntu
          echo "‚úÖ Hardened image built successfully: ${TAG}:latest"

      # ---------------------------------------------------------------------
      # Step 6 - Security Scan (Trivy)
      # ---------------------------------------------------------------------
      - name: üîç Scan image using Trivy
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"
          mkdir -p reports
          echo "üîç Running Trivy scan on ${TAG}:latest..."
          trivy image "${TAG}:latest" -f json -o reports/trivy-${TAG}.json --severity HIGH,CRITICAL || true
          echo "‚úÖ Security scan completed."

      # ---------------------------------------------------------------------
      # Step 7 - Upload Reports
      # ---------------------------------------------------------------------
      - name: üì§ Upload scan report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-${{ env.OS_NAME }}-report
          path: reports/

      # ---------------------------------------------------------------------
      # Step 8 - Upload to S3
      # ---------------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload compliance report to S3
        run: python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------------------
      # Step 9 - Update Changelog
      # ---------------------------------------------------------------------
      - name: ü™∂ Update changelog
        run: |
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ env.OS_NAME }}" \
            --cis_profile "cis${{ env.CIS_VERSION }}" \
            --version "v1.0.0" \
            --build_date "$(date +%Y%m%d)" \
            --summary "CIS ${{ env.CIS_VERSION }} compliance and security updates"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
