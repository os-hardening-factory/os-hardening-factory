name: üêß Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"
      ACCOUNT_ID: "661539128717"
      PACKER_VERSION: "1.14.2"

    steps:
      # 1Ô∏è‚É£ Checkout Code
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials (OIDC)
      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Base dependencies
      - name: üîß Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip jq python3-pip

      # 4Ô∏è‚É£ Install packer
      - name: üì¶ Install Packer
        run: |
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

      # 5Ô∏è‚É£ Initialize and validate packer
      - name: üß© Initialize and validate Packer
        run: |
          packer init packer/ubuntu
          packer validate packer/ubuntu

      # 6Ô∏è‚É£ Build hardened Ubuntu image
      - name: üèóÔ∏è Build hardened Ubuntu image
        run: |
          DATE=$(date +%Y%m%d)
          COMMIT=$(echo "${GITHUB_SHA}" | cut -c1-7)
          BASE_TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}"
          IMAGE_NAME="${BASE_TAG}-hardening-${DATE}"
          echo "Building image: ${IMAGE_NAME}"
          SOURCE_AMI="ami-05a8df10b57fXXXX"
          packer build \
            -var "image_name=${IMAGE_NAME}" \
            -var "base_image=ubuntu:${{ env.OS_VERSION }}" \
            -var "cis_profile=cis${{ env.CIS_VERSION }}" \
            -var "build_date=${DATE}" \
            -var "git_commit=${COMMIT}" \
            -var "source_ami=${SOURCE_AMI}" \
            packer/ubuntu

          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
          echo "BASE_TAG=${BASE_TAG}" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Push hardened image to ECR (immutable)
      - name: üß± Tag and push hardened image to ECR
        run: |
          DATE=$(date +%Y%m%d)
          TIME=$(date +%H%M%S)
          COMMIT=${{ env.COMMIT }}
          BASE_TAG=${{ env.BASE_TAG }}
          FULL_TAG="${BASE_TAG}-${DATE}${TIME}-${COMMIT}"

          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS \
              --password-stdin ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

          docker tag ${BASE_TAG}-hardening-${DATE}:latest \
            ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}
          docker push ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}

          echo "FULL_TAG=${FULL_TAG}" >> $GITHUB_ENV
          echo "‚úÖ Image pushed with immutable tag: ${FULL_TAG}"

      # 8Ô∏è‚É£ Generate semantic enterprise tag (1.x style)
      - name: üè∑Ô∏è Generate enterprise tag (semantic 1.x versioning)
        id: semver
        run: |
          VENDOR="${{ env.OS_NAME }}"
          VERSION="${{ env.OS_VERSION }}"
          VARIANT="intuit"

          EXISTING_TAGS=$(aws ecr list-images \
            --repository-name hardened-${VENDOR} \
            --region ${{ env.AWS_REGION }} \
            --query "imageIds[?starts_with(imageTag, \`${VENDOR}-${VERSION}-${VARIANT}\`)].imageTag" \
            --output text)

          BASE_VERSION="1.0"
          if [ -z "$EXISTING_TAGS" ]; then
            NEW_VERSION=$BASE_VERSION
          else
            LAST_TAG=$(echo "$EXISTING_TAGS" | tr '\t' '\n' | sort -V | tail -n 1)
            LAST_VERSION=$(echo "$LAST_TAG" | awk -F '-' '{print $NF}')
            MAJOR=$(echo "$LAST_VERSION" | cut -d. -f1)
            MINOR=$(echo "$LAST_VERSION" | cut -d. -f2)
            NEXT_MINOR=$((MINOR + 1))
            NEW_VERSION="${MAJOR}.${NEXT_MINOR}"
          fi

          ENTERPRISE_TAG="${VENDOR}-${VERSION}-${VARIANT}-${NEW_VERSION}"
          echo "ENTERPRISE_TAG=${ENTERPRISE_TAG}" >> $GITHUB_ENV
          echo "üöÄ New enterprise tag: ${ENTERPRISE_TAG}"

      - name: üß± Prepare reports directory
        run: |
          mkdir -p reports
          echo "‚úÖ reports/ folder created at $(pwd)/reports"

      - name: üß™ Create dummy compliance report (debug)
        run: |
          echo '{"os":"ubuntu","status":"upload test","timestamp":"'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"}' > reports/test-report.json
          echo "‚úÖ Created test report file:"
          ls -l reports/



      # 9Ô∏è‚É£ Upload compliance reports to S3 and trigger AWS Glue crawler
      - name: ‚òÅÔ∏è Upload reports to S3 and trigger Glue
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          pip3 install boto3
          python3 tools/upload_to_s3_and_trigger_glue.py \
            --bucket cloud-secure-infra-dev-image-metadata-ap-south-1 \
            --region ${{ env.AWS_REGION }} \
            --os ${{ env.OS_NAME }} \
            --build_date $(date +%Y%m%d)
