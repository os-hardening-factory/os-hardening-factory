name: ðŸ§ Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"
      ACCOUNT_ID: "661539128717"
      PACKER_VERSION: "1.14.2"

    steps:
      # 1ï¸âƒ£ Checkout Code
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configure AWS credentials (OIDC)
      - name: ðŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.ACCOUNT_ID }}:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # 3ï¸âƒ£ Base dependencies
      - name: ðŸ”§ Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip jq python3-pip

      # 4ï¸âƒ£ Install packer
      - name: ðŸ“¦ Install Packer
        run: |
          curl -fsSL "https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip" -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

      # 5ï¸âƒ£ Initialize and validate packer
      - name: ðŸ§© Initialize and validate Packer
        run: |
          packer init packer/ubuntu
          packer validate packer/ubuntu

      # 6ï¸âƒ£ Build hardened Ubuntu image
      - name: ðŸ—ï¸ Build hardened Ubuntu image
        run: |
          DATE=$(date +%Y%m%d)
          COMMIT=$(echo "${GITHUB_SHA}" | cut -c1-7)
          BASE_TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}"
          IMAGE_NAME="${BASE_TAG}-hardening-${DATE}"

          echo "ðŸš€ Building image: ${IMAGE_NAME}"
          packer build \
            -var "image_name=${IMAGE_NAME}" \
            -var "base_image=ubuntu:${{ env.OS_VERSION }}" \
            -var "cis_profile=cis${{ env.CIS_VERSION }}" \
            packer/ubuntu

          echo "DATE=${DATE}" >> $GITHUB_ENV
          echo "COMMIT=${COMMIT}" >> $GITHUB_ENV
          echo "BASE_TAG=${BASE_TAG}" >> $GITHUB_ENV

      # 7ï¸âƒ£ Tag and push to ECR
      - name: ðŸ§± Tag and push hardened image to ECR
        run: |
          DATE=${{ env.DATE }}
          COMMIT=${{ env.COMMIT }}
          BASE_TAG=${{ env.BASE_TAG }}
          FULL_TAG="${BASE_TAG}-${DATE}-${COMMIT}"
          LATEST_TAG="${BASE_TAG}-latest"

          echo "ðŸ”¹ Full tag: ${FULL_TAG}"
          echo "ðŸ”¹ Latest tag: ${LATEST_TAG}"

          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS \
              --password-stdin ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

          docker tag ${BASE_TAG}-hardening-${DATE}:latest \
            ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}

          docker tag ${BASE_TAG}-hardening-${DATE}:latest \
            ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${LATEST_TAG}

          docker push ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${FULL_TAG}
          docker push ${{ env.ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/hardened-${{ env.OS_NAME }}:${LATEST_TAG}

          echo "FULL_TAG=${FULL_TAG}" >> $GITHUB_ENV
          echo "âœ… Image pushed successfully to ECR"
