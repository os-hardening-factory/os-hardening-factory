name: ğŸ§ Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ”§ Install dependencies (no containerd conflicts)
        run: |
          set -e
          echo "ğŸ”§ Installing safe dependencies..."

          # Base tools only
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip gpg lsb-release jq

          # âœ… Install Packer via binary (no apt)
          echo "ğŸ“¦ Installing Packer binary..."
          PACKER_VERSION="1.14.2"
          curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
          sudo unzip -o packer.zip -d /usr/local/bin/
          rm -f packer.zip
          packer version

          # âœ… Use runnerâ€™s preinstalled Docker
          echo "ğŸ‹ Verifying Docker environment..."
          docker --version || (echo "âŒ Docker not found" && exit 1)
          docker info || (echo "âŒ Docker daemon unavailable" && exit 1)

          # âœ… Trivy binary install (no apt or containerd)
          echo "ğŸ” Installing Trivy binary..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          sudo mv trivy /usr/local/bin/trivy
          trivy --version

          # âœ… Python libs
          pip3 install boto3 PyGithub

          echo "âœ… Dependencies installed safely."

      - name: ğŸ§© Initialize and validate Packer
        run: |
          packer init packer/ubuntu
          packer validate packer/ubuntu

      - name: ğŸ—ï¸ Build hardened Ubuntu image
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"

          echo "ğŸš€ Building image: $TAG"
          packer build \
            -var "local_tag=latest" \
            -var "image_name=${TAG}" \
            -var "base_image=ubuntu:22.04" \
            packer/ubuntu

      - name: ğŸ” Scan image using Trivy
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"

          echo "ğŸ” Scanning image: ${TAG}:latest"
          mkdir -p reports
          trivy image "${TAG}:latest" --format json -o reports/trivy-${TAG}.json || true

      - name: â˜ï¸ Upload compliance report to S3
        run: |
          python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: ğŸª¶ Update vendor changelog
        run: |
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ env.OS_NAME }}" \
            --cis_profile "cis${{ env.CIS_VERSION }}" \
            --version "v1.0.0" \
            --build_date "$(date +%Y%m%d)" \
            --summary "CIS ${{ env.CIS_VERSION }} compliance and OS security patches"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
