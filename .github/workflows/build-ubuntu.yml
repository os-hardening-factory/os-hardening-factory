name: üêß Ubuntu Hardened Image Build

on:
  workflow_dispatch:

jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    env:
      OS_NAME: "ubuntu"
      OS_VERSION: "22.04"
      CIS_VERSION: "1.4"
      AWS_REGION: "ap-south-1"

    steps:
      # ---------------------------------------------------------------------
      # Step 1: Checkout Repository
      # ---------------------------------------------------------------------
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------------------
      # Step 2: Configure AWS OIDC Authentication
      # ---------------------------------------------------------------------
      - name: üîê Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::661539128717:role/GitHubActionsFactoryRole
          aws-region: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------------------
      # Step 3: Install Dependencies (No Docker or containerd conflicts)
      # ---------------------------------------------------------------------
      - name: üîß Install dependencies (Packer, Trivy, Python)
        run: |
          set -e
          echo "üîß Installing dependencies..."

          # Base tools
          sudo apt-get update -y
          sudo apt-get install -y wget curl unzip python3-pip gpg lsb-release software-properties-common

          # ‚úÖ Packer from HashiCorp repo
          wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com noble main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt-get update -y && sudo apt-get install -y packer

          # ‚úÖ Use preinstalled Docker only (avoid containerd.io)
          echo "üêã Verifying Docker availability..."
          docker --version || (echo "‚ùå Docker missing in runner" && exit 1)
          docker info || (echo "‚ùå Docker daemon not responding" && exit 1)

          # ‚úÖ Trivy binary install (bypass apt)
          echo "üì¶ Installing Trivy from binary..."
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          sudo mv trivy /usr/local/bin/trivy
          trivy --version

          # ‚úÖ Python dependencies
          pip3 install boto3 PyGithub

          echo "‚úÖ All dependencies installed successfully. No containerd conflicts detected."

      # ---------------------------------------------------------------------
      # Step 4: Initialize & Validate Packer
      # ---------------------------------------------------------------------
      - name: üß© Initialize and validate Packer
        run: |
          packer init packer/ubuntu
          packer validate packer/ubuntu

      # ---------------------------------------------------------------------
      # Step 5: Build Hardened Ubuntu Image
      # ---------------------------------------------------------------------
      - name: üèóÔ∏è Build hardened image for Ubuntu
        run: |
          TIMESTAMP=$(date +%Y%m%d)
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-${TIMESTAMP}"

          echo "üöÄ Building hardened image: $TAG"
          packer build \
            -var "local_tag=latest" \
            -var "image_name=${TAG}" \
            -var "base_image=ubuntu:22.04" \
            packer/ubuntu

      # ---------------------------------------------------------------------
      # Step 6: Security Scan via Trivy
      # ---------------------------------------------------------------------
      - name: üîç Scan hardened image using Trivy
        run: |
          TAG="${{ env.OS_NAME }}-${{ env.OS_VERSION }}-cis${{ env.CIS_VERSION }}-hardening-$(date +%Y%m%d)"
          echo "üîç Scanning hardened image: $TAG"
          mkdir -p reports
          trivy image "${TAG}:latest" --format json -o "reports/trivy-${TAG}.json" || true

      # ---------------------------------------------------------------------
      # Step 7: Upload Compliance Report to S3
      # ---------------------------------------------------------------------
      - name: ‚òÅÔ∏è Upload compliance report to S3
        run: |
          python3 tools/upload_to_s3_and_trigger_glue.py
        env:
          AWS_REGION: ${{ env.AWS_REGION }}

      # ---------------------------------------------------------------------
      # Step 8: Update Vendor Changelog
      # ---------------------------------------------------------------------
      - name: ü™∂ Update vendor changelog + release info
        run: |
          python3 tools/dispatch_to_vendor_repos.py \
            --vendor "${{ env.OS_NAME }}" \
            --cis_profile "cis${{ env.CIS_VERSION }}" \
            --version "v1.0.0" \
            --build_date "$(date +%Y%m%d)" \
            --summary "CIS ${{ env.CIS_VERSION }} compliance + security updates applied"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
